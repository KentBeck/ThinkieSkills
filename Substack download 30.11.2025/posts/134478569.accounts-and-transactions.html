<p><a href="https://tidyfirst.substack.com/p/what-if-you-are-going-to-need-it">In</a> <a href="https://tidyfirst.substack.com/p/never-forget">this</a> <a href="https://tidyfirst.substack.com/p/when-did-it-happen-when-did-we-find">series</a> we explore a business architecture thatâ€™s more complex than obviously necessary, but where each complication creates value over time.</p><blockquote><p>Watch designers speak in terms of â€œcomplicationsâ€ instead of â€œfeaturesâ€. I love this framing because it simultaneously reminds everyone of both costs &amp; benefits.</p></blockquote><p>So far we have discussed:</p><ol><li><p>We want the flexibility of human processing with the scale &amp; economy of automated processing.</p></li><li><p>So we save all data needed to recreate the history of a contract.</p></li><li><p>But the real world out there &amp; the ideal world of the system diverge.</p></li><li><p>So we tag all data with both the date on which data became true in the real world &amp; the date on which the system learned about that data (bi-temporality).</p></li></ol><p>Now we come to the next complication: reproduction. We would like to be able to re-run the entire history of a contract from inception to the present moment &amp; get exactly the same results as those we currently have stored (the actual differences will be interesting). </p><p>â€œThat fee is outrageous! Iâ€™ll only pay half that.â€ â€œBut that was 5 years ago!â€ â€œI donâ€™t care.â€ Imagine being able to retroactively change the fee, re-run the entire 5 years worth of transactions, &amp; confidently seeing how the balances have changed.</p><p>To replay history we must record it.</p><h2>Accounts &amp; Transactions</h2><p>Therefore, record monetary flows as transactions between accounts. Bi-temporally stamp these transactions. Implement business logic by reading account balances &amp; posting new transactions.</p><blockquote><p>There is a whole Tao Te Ching é“å¾·ç¶“ interpretation of double entry bookkeeping which Iâ€™m not going to describe here because Iâ€™m no initiate. Feel free to explore.</p></blockquote><p>What accounts do you need? Thatâ€™s a matter of style, judgement, &amp; iteration. In general, have an account any time a balance is interesting to someone. â€œHow much have I paid in premiums?â€ Account. â€œHow much risk did we re-insure?â€ Account. â€œWhat is the current street address?â€ Not an account (but maybe it should beâ€”try it some time).</p><h2>Implementation: Structure</h2><blockquote><p>SubStack is responding differently to indenting than it has before for me. Iâ€™m afraid youâ€™ll have to fill in the leading whitespace yourself until I get it figured out.</p></blockquote><p>Here is the basic test weâ€™d like to pass:</p><p><code>monday = 1<br>tuesday = 2<br>wednesday = 3<br>thursday = 4<br>source = Account()<br>destination = Account()<br>Transaction.post(source, destination, 100, tuesdayAsOfTuesday)<br>mondayAsOfMonday = Perspective(effective=monday, posting=monday)<br>assert source.balance(mondayAsOfMonday) == 0<br>tuesdayAsOfTuesday = Perspective(tuesday, tuesday)<br>assert source.balance(tuesdayAsOfTuesday) == -100<br>tuesdayAsOfThursday = Perspective(thursday, tuesday)<br>assert destination.balance(tuesdayAsOfThursday) == 100</code></p><p>Letâ€™s take this top down. The object structure we want to create looks like this:</p><div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/$s_!NAR7!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6652527d-bc71-4259-87ba-d76763b845b7_2960x1323.png" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!NAR7!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6652527d-bc71-4259-87ba-d76763b845b7_2960x1323.png 424w, https://substackcdn.com/image/fetch/$s_!NAR7!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6652527d-bc71-4259-87ba-d76763b845b7_2960x1323.png 848w, https://substackcdn.com/image/fetch/$s_!NAR7!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6652527d-bc71-4259-87ba-d76763b845b7_2960x1323.png 1272w, https://substackcdn.com/image/fetch/$s_!NAR7!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6652527d-bc71-4259-87ba-d76763b845b7_2960x1323.png 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/6652527d-bc71-4259-87ba-d76763b845b7_2960x1323.png" width="1456" height="651" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/6652527d-bc71-4259-87ba-d76763b845b7_2960x1323.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:651,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:4047895,&quot;alt&quot;:&quot;The source account's debits contains the transaction &amp; the destination accounts credits contains the transaction.&quot;,&quot;title&quot;:&quot;The source account's debits contains the transaction &amp; the destination accounts credits contains the transaction.&quot;,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="The source account's debits contains the transaction &amp; the destination accounts credits contains the transaction." title="The source account's debits contains the transaction &amp; the destination accounts credits contains the transaction." srcset="https://substackcdn.com/image/fetch/$s_!NAR7!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6652527d-bc71-4259-87ba-d76763b845b7_2960x1323.png 424w, https://substackcdn.com/image/fetch/$s_!NAR7!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6652527d-bc71-4259-87ba-d76763b845b7_2960x1323.png 848w, https://substackcdn.com/image/fetch/$s_!NAR7!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6652527d-bc71-4259-87ba-d76763b845b7_2960x1323.png 1272w, https://substackcdn.com/image/fetch/$s_!NAR7!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6652527d-bc71-4259-87ba-d76763b845b7_2960x1323.png 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><p>The external API for posting a transaction seems to fit nicely as a factory method on Transaction:</p><p><code>class Transaction:<br>  @staticmethod<br>  def post(source, destination, amount, perspective):<br>    result = Transaction(source, destination, amount, perspective)<br>    result._post()<br>    return result</code></p><p><code>@staticmethod<br> def post(source, destination, amount, perspective):<br>    result = Transaction(source, destination, amount, perspective)<br>    result._post()<br>    return result</code></p><p>This method both creates side effects &amp; returns a new object. Some folks would tsk tsk ğŸ¤ŒğŸ». Too bad. Write your own code.</p><p>Supporting the factory method are the private __init__ &amp; _post methods:</p><p>  <code>  def __init__(self, source, destination, amount, perspective):<br>       self._source = source<br>       self._destination = destination<br>       self._amount = amount<br>       self._perspective = perspective<br>   def perspective(self):<br>       return self._perspective<br>   def _post(self):<br>       self._source.debit(self)<br>       self._destination.credit(self)</code></p><p>An Account stores 2 Histories of Transactions, one for credits &amp; one for debits. (Real accountants are likely cringing by nowâ€”we are using â€œaccounts &amp; transactionsâ€ as a metaphor, not implementing genuine double entry bookkeeping.)</p><p><code>class Account:<br>    def __init__(self):<br>        self._credits = History()<br>        self._debits = History()<br>    def credit(self, transaction):<br>        self._credits.add(transaction, transaction.perspective())<br>    def debit(self, transaction):<br>        self._debits.add(transaction, transaction.perspective())</code></p><p>(I went back and forth whether to pull the perspective out here or pass it as an explicit parameter. I decided that this better expressed the invariant that the transaction is always stored under its own perspective.)</p><h2>Implementation: Behavior</h2><p>Now that we have the object structure we want, we can implement the balance() method.</p><p><code>class Account:<br>    def balance(self, perspective):<br>        credit = self._balanceOn(self._credits, perspective)<br>        debit = self._balanceOn(self._debits, perspective)<br>        return credit - debit</code></p><p>This relies on a helper that sums the amounts of the visible transactions in a History.</p><p><code>    def _balanceOn(self, transactions, perspective):<br>        return sum(map(lambda x: x.amount(), transactions.seen(perspective)))</code></p><p>If you remember History from the last couple of posts, we need an accessor that returns only the seen elements. Here it is for completeness:</p><p><code>class History:<br>    def _seen(self, perspective):<br>        return filter(lambda x: perspective.sees(x[0]), self._events)<br>    def seen(self, perspective):<br>        return map(lambda x: x[1], self._seen(perspective))</code></p><p>(We are inching ever closer to the dreaded range query for History, which Iâ€™m really hoping to avoid.)</p><h2>Conclusion</h2><p>There you have it. It would seem easy enough to implement some business logic by just querying a bunch of domain objects, writing the results somewhere temporary, summing the results, issuing a report, and then forgetting the intermediate state. This, however, would prevent you from reproducing the current state.</p><p>Instead, consider adding the additional complication of storing intermediate business results as transactions in accounts. Implement business logic by querying balances or unprocessed transactions &amp; posting new transactions. Eventually there will be an account like â€œowed to customerâ€ or â€œowed to governmentâ€. Processing those accounts will cause change in the outside world.</p><p>One limitation of this approach is that you canâ€™t (yet?) easily reproduce earlier states of the code. If you process yesterdayâ€™s data with todayâ€™s logic, you could easily come up with different answers than you did yesterday. In practice this doesnâ€™t come up that often, but itâ€™s interesting to imagine automatic solutions. A bi-temporal code repository? Hmmmâ€¦</p><p>The ability to replay history may be surprising &amp; novel to the business. Business invented the concept of â€œclosingâ€ (as in â€œyear-end closingâ€) to sweep the sins of the past under the rug. Retroactive changes become exercises in accounting legerdemain. Donâ€™t expect the business to adapt instantly.</p><p>Note that our transactions arenâ€™t the only thing we will need to explain the history of a contract. We also need a Document Store (to be described later) to account for all correspondence sent &amp; received. </p>