<blockquote><p>First published in 2017. I was already wrestling with the question of “when” as the critical design decision. Also, you can see the roots of the “empirical” in Empirical Software Design here.</p><p>Commission me to deliver <a href="mailto:kentlbeck@gmail.com">a custom talk</a> to your development organization. Your choice of format, topic, &amp; location.</p></blockquote><p>My intention in this note is to reclaim the phrase <em>ad hoc </em>from those who use it as a pejorative, especially as applied to infrastructure. Instead, building infrastructure <em>ad hoc </em>is the safest, most efficient strategy. It carefully balances the risks inherent in creating infrastructure, stages investment, and realizes economies of scale.</p><h2><strong>“Infrastructure”?</strong></h2><p>Imagine we have lots of code like this:</p><pre><code>value = memcache.get(key)
if (! value) {
  value = database.get(key)
  memcache.put(key, value)
}
...value...</code></pre><p>This code requires three network calls in the case of a cache miss, <em>expensive</em> network calls going from the front end servers to the data storage servers. Suppose we replace these 3 calls with a single call:</p><pre><code>value = cache.get(key)</code></pre><p>(Assuming we set up the cache to know how to fetch its underlying data.)</p><p>The front end no longer has to care about how to fill the cache. The cache machines can be located close (in the network sense) to the database machines, so a cache miss no longer incurs as much of a penalty.</p><p>Once the cache is in place, we can continually improve cache hit rates, reduce latency on misses, and improve behavior for “hot” keys all without changing the front end code at all. A small improvement to the cache’s behavior results in a large return on investment because of scale.</p><p>That’s what infrastructure is: a (mostly) isolated bundle of related functionality achieving economies of scale. Those economies may come from reduced capital expenditure (fewer servers needed for the same data) or reduced operating expenditure (shorter mean time to repair because the functionality can be economically refined).</p><p>So far I haven’t said anything controversial (I hope). But…</p><p>When should such infrastructure be built? What goes into the infrastructure? These are questions that provoke furious debate.</p><h2><strong>The Myth</strong></h2><p>The myth is “build the infrastructure and then build the apps on top of it”.</p><div class="captioned-image-container"><figure><a class="image-link image2" target="_blank" href="https://substackcdn.com/image/fetch/$s_!dd-I!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e001263-fb0d-4ead-825b-71b6ac488078_570x182.png" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!dd-I!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e001263-fb0d-4ead-825b-71b6ac488078_570x182.png 424w, https://substackcdn.com/image/fetch/$s_!dd-I!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e001263-fb0d-4ead-825b-71b6ac488078_570x182.png 848w, https://substackcdn.com/image/fetch/$s_!dd-I!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e001263-fb0d-4ead-825b-71b6ac488078_570x182.png 1272w, https://substackcdn.com/image/fetch/$s_!dd-I!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e001263-fb0d-4ead-825b-71b6ac488078_570x182.png 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/3e001263-fb0d-4ead-825b-71b6ac488078_570x182.png" width="570" height="182" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/3e001263-fb0d-4ead-825b-71b6ac488078_570x182.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:182,&quot;width&quot;:570,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:151362,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/$s_!dd-I!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e001263-fb0d-4ead-825b-71b6ac488078_570x182.png 424w, https://substackcdn.com/image/fetch/$s_!dd-I!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e001263-fb0d-4ead-825b-71b6ac488078_570x182.png 848w, https://substackcdn.com/image/fetch/$s_!dd-I!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e001263-fb0d-4ead-825b-71b6ac488078_570x182.png 1272w, https://substackcdn.com/image/fetch/$s_!dd-I!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3e001263-fb0d-4ead-825b-71b6ac488078_570x182.png 1456w" sizes="100vw" loading="lazy"></picture><div></div></div></a></figure></div><p>This trick never works (for some value of “never”). Building the infrastructure is a never-ending project. When is it good enough for apps? Tomorrow. Always tomorrow. What should go into the infrastructure? More. Always more.</p><p>Infrastructure is supposed to be built more carefully than apps. Apps gain value from exploration &amp; thus emphasize latency of experiments. Infrastructure gains value from scale. Mistakes or inefficiencies scale too. However, infrastructure is not built with perfect knowledge. Infrastructure needs to grow &amp; adapt.</p><p>“When?” should, then, be answered with “some sooner, some later”.</p><h2><strong>Ad Hoc Infrastructure</strong></h2><p>I’ve heard people critique as system as “ad hoc”. Hang on! </p><blockquote><p>ad hoc /ˌad ˈhäk/<br>adverb<br>    when necessary or needed.<br>adjective<br>    created or done for a particular purpose as necessary.</p></blockquote><p>I <em>like</em> both those definitions. Why would you create infrastructure before it is necessary? Why would you create infrastructure that’s not needed?</p><p>The “ad hoc” answers to the infrastructure question:</p><ul><li><p>When? After an application already has the functionality, but in a clearly inferior form.</p></li><li><p>How much? Just as much as will let the application return to only doing its job.</p></li></ul><div class="captioned-image-container"><figure><a class="image-link image2" target="_blank" href="https://substackcdn.com/image/fetch/$s_!0yJ0!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F901fabe0-4446-4d64-b465-a8f17d3f3358_559x176.png" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!0yJ0!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F901fabe0-4446-4d64-b465-a8f17d3f3358_559x176.png 424w, https://substackcdn.com/image/fetch/$s_!0yJ0!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F901fabe0-4446-4d64-b465-a8f17d3f3358_559x176.png 848w, https://substackcdn.com/image/fetch/$s_!0yJ0!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F901fabe0-4446-4d64-b465-a8f17d3f3358_559x176.png 1272w, https://substackcdn.com/image/fetch/$s_!0yJ0!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F901fabe0-4446-4d64-b465-a8f17d3f3358_559x176.png 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/901fabe0-4446-4d64-b465-a8f17d3f3358_559x176.png" width="559" height="176" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/901fabe0-4446-4d64-b465-a8f17d3f3358_559x176.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:176,&quot;width&quot;:559,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:141616,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/$s_!0yJ0!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F901fabe0-4446-4d64-b465-a8f17d3f3358_559x176.png 424w, https://substackcdn.com/image/fetch/$s_!0yJ0!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F901fabe0-4446-4d64-b465-a8f17d3f3358_559x176.png 848w, https://substackcdn.com/image/fetch/$s_!0yJ0!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F901fabe0-4446-4d64-b465-a8f17d3f3358_559x176.png 1272w, https://substackcdn.com/image/fetch/$s_!0yJ0!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F901fabe0-4446-4d64-b465-a8f17d3f3358_559x176.png 1456w" sizes="100vw" loading="lazy"></picture><div></div></div></a><figcaption class="image-caption">Infrastructure derived from experience</figcaption></figure></div><p>Ad hoc infrastructure achieves economies of scale by using regret as the primary motivation. “I wish we had built this a different way...” leads to building a small part of the application in a better way, a way that just so happens to be useful for other apps after a bit of tweaking.</p><p class="button-wrapper" data-attrs="{&quot;url&quot;:&quot;https://tidyfirst.substack.com/subscribe?&quot;,&quot;text&quot;:&quot;Subscribe now&quot;,&quot;action&quot;:null,&quot;class&quot;:null}" data-component-name="ButtonCreateButton"><a class="button primary" href="https://tidyfirst.substack.com/subscribe?"><span>Subscribe now</span></a></p>