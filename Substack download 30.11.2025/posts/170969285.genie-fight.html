<p>The goal of the <a href="https://github.com/KentBeck/BPlusTree3">B+ Tree Project</a> is to see if an augmented coding project can result in a library-quality data structure. Reliability is job #1 &amp; performance is job #2 &amp; if both jobs aren’t done then the experiment doesn’t support the hypothesis.</p><p>Tests have done a decent job of assessing reliability. Some day I’ll talk about the fuzz tester I had the genie write. But when I get the genie to run all the tests &amp; take the results seriously, I feel pretty good about the reliability.</p><p>Performance is another matter. I ask the genie “compare the performance of BPlusTreeMap with BTreeMap” &amp; it comes back with wildly varying answers, even when the performance hasn’t changed.</p><div><hr></div><p><em>Personal ad: let me know if your team could use consulting assistance. I’m particularly interested in San Francisco Bay Area clients but willing to travel. A couple of recent engagements:</em></p><ul><li><p><em>Helped a large, conservative financial organization ship a large, complicated financial system <strong>one year</strong> ahead of schedule.</em></p></li><li><p><em>Helped a scale-up form a community of senior engineers to accelerate scaling.</em></p></li></ul><p><em>My services are expensive but worth it.</em></p><div class="directMessage button" data-attrs="{&quot;userId&quot;:24333739,&quot;userName&quot;:&quot;Kent Beck&quot;,&quot;canDm&quot;:null,&quot;dmUpgradeOptions&quot;:null,&quot;isEditorNode&quot;:true}" data-component-name="DirectMessageToDOM"></div><div><hr></div><h2>Sidebar: B Tree Versus B+ Tree</h2><p>Quick data structure refresher in case, like me, you needed it. We want to store some keys (values too, but we’ll ignore them for the moment). We want to look up keys quickly, so we build a tree of nodes containing the keys. That way asking “does this key exist” will require visiting O(log n) nodes, where n is the number of keys.</p><div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/$s_!tq-q!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8cde391-fcf0-4fa8-9219-3de31bef2f31.heic" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!tq-q!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8cde391-fcf0-4fa8-9219-3de31bef2f31.heic 424w, https://substackcdn.com/image/fetch/$s_!tq-q!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8cde391-fcf0-4fa8-9219-3de31bef2f31.heic 848w, https://substackcdn.com/image/fetch/$s_!tq-q!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8cde391-fcf0-4fa8-9219-3de31bef2f31.heic 1272w, https://substackcdn.com/image/fetch/$s_!tq-q!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8cde391-fcf0-4fa8-9219-3de31bef2f31.heic 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/d8cde391-fcf0-4fa8-9219-3de31bef2f31.heic" width="1456" height="760" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/d8cde391-fcf0-4fa8-9219-3de31bef2f31.heic&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:760,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:215414,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/heic&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:&quot;https://tidyfirst.substack.com/i/170969285?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8cde391-fcf0-4fa8-9219-3de31bef2f31.heic&quot;,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/$s_!tq-q!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8cde391-fcf0-4fa8-9219-3de31bef2f31.heic 424w, https://substackcdn.com/image/fetch/$s_!tq-q!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8cde391-fcf0-4fa8-9219-3de31bef2f31.heic 848w, https://substackcdn.com/image/fetch/$s_!tq-q!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8cde391-fcf0-4fa8-9219-3de31bef2f31.heic 1272w, https://substackcdn.com/image/fetch/$s_!tq-q!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd8cde391-fcf0-4fa8-9219-3de31bef2f31.heic 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><p>Here we’ve stored 1, 3, 4, 5, 6, 10, 12, 15, 16, 18, 20, &amp; 25.</p><p>Inserting a new key requires finding the node where the key belongs (again, O(log n)) &amp; inserting it into that node. If that would make the node too big, the node needs to split. This split can require the parent node to split, &amp; so on up to the root. Delete is even more fun. Another day.</p><p>The problem with B trees is that the API isn’t just get(), put(), &amp; delete(). There’s also:</p><p><code>  for key in keys.irange(6, 15):</code> <br><code>      do_something(key)</code></p><p>In a B tree this “range scan” (frequently used in databases—think pagination) requires potentially bouncing around the whole tree. If k is the number of elements in the range, this can visit O(k * log n) nodes.</p><p>The B+ tree optimizes this operation at the cost of some duplication of storage. Like the B tree we will store a tree of nodes that index into the data. However, at the leaves we will store all the keys in sorted order. In addition, each leaf stores a pointer to the next leaf.</p><div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/$s_!k-zK!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4658dd5d-54bc-450d-89a3-6f26fff10202.heic" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!k-zK!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4658dd5d-54bc-450d-89a3-6f26fff10202.heic 424w, https://substackcdn.com/image/fetch/$s_!k-zK!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4658dd5d-54bc-450d-89a3-6f26fff10202.heic 848w, https://substackcdn.com/image/fetch/$s_!k-zK!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4658dd5d-54bc-450d-89a3-6f26fff10202.heic 1272w, https://substackcdn.com/image/fetch/$s_!k-zK!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4658dd5d-54bc-450d-89a3-6f26fff10202.heic 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/4658dd5d-54bc-450d-89a3-6f26fff10202.heic" width="1456" height="676" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/4658dd5d-54bc-450d-89a3-6f26fff10202.heic&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:676,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:301581,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/heic&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:&quot;https://tidyfirst.substack.com/i/170969285?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4658dd5d-54bc-450d-89a3-6f26fff10202.heic&quot;,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/$s_!k-zK!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4658dd5d-54bc-450d-89a3-6f26fff10202.heic 424w, https://substackcdn.com/image/fetch/$s_!k-zK!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4658dd5d-54bc-450d-89a3-6f26fff10202.heic 848w, https://substackcdn.com/image/fetch/$s_!k-zK!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4658dd5d-54bc-450d-89a3-6f26fff10202.heic 1272w, https://substackcdn.com/image/fetch/$s_!k-zK!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4658dd5d-54bc-450d-89a3-6f26fff10202.heic 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><p>For get(), we use the branch nodes to navigate to the right leaf, then retrieve the key from the leaf. (If we just want to know if the key exists, we can stop as soon as we see the key in the branch node, but that’s the less frequently used operation.)</p><p>For the range scan operation, though, we navigate to the beginning leaf using the start key, then follow the chain of leaves until we hit the end key. No bouncing around the branch nodes. This operation costs O(log n + k). Times a million servers. Times a billion times a day. It adds up. The log n gets us to the right leaf, then there’s k for the overhead per key in the range.</p><p>(Again, insert() is tricky because of node splitting &amp; delete() is even trickier because of node merging &amp; again I’m going to leave all that fun for another day.)</p><p>Back to the genies…</p><h2>Lying Liars</h2><p>Okay, so we have an existing data structure—BTreeMap—and we want to compare its performance to our new data structure—BPlusTreeMap. We ask the genie:</p><ul><li><p>“How does the BPlusTreeMap performance compare to the BTreeMap?” “It’s excellent! Insert performance in small trees is only 3.1x slower!”</p></li><li><p>“Um, try this—write a benchmark with a big tree and compare.” “BPlusTreeMap is unusably slow. Delete performance is only 0.98x as fast.”</p></li><li><p>“Whu? Give me a balanced benchmark across get, insert, delete, &amp; range scan.” “BPlusTreeMap is a superior solution, with insert performance only 13.1x slower.”</p></li></ul><p>Okay, this conversation is going nowhere. Even with the same prompt the answers are a) wildly inconsistent and b) misleading (saying it’s competitive when it’s an order of magnitude slower). Variations of the prompt (e.g. “slower than” versus “faster than”) yield completely different results.</p><p>And yet, I need a trustworthy answer to my question to evaluate the experiment.</p><h2>Genie’s Dilemma</h2><p>I don’t think 2 genies can actually be in a Prisoner’s Dilemma, but the setup is the same—2 suspects in 2 rooms &amp; they can’t communicate. I got ahold of one of the remote agent platforms, opened 2 genies on separate development servers. The first I gave my usual development instructions—here’s the goal, TDD please, etc. The second I told: “You are an auditor for the BPlusTreeMap project. Your job is to make sure that no performance regressions happen because of replacing BTreeMap with BPlusTreeMap.”</p><p>Magic. All I have to say is, “Pull the latest version &amp; evaluate.” The auditor came up  with its own benchmarks. Runs them consistently. Reports them consistently. Doesn’t seem to be “invested” (yes, I know I’m anthropomorphizing here) in any particular answer.</p><h2>Whoopsie…</h2><p>I like the isolated genie trick so much that I tried it again. I introduced a third genie, the Editor, whose job it was to make the code more readable. Grind grind grind. And there, fortunately in an isolated dev server, all the code was gone. Fewer lines, less to read, amiright?</p><p>Okay, so I still have a lot to learn about the isolated genie trick.</p>