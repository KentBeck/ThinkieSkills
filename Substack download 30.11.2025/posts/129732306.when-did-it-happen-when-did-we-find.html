<blockquote><p>First, a big shout-out to Massimo Arnoldi &amp; the folks at Lifeware for teaching me these patterns. They were distilled from decades of experience operating tracking let’s just say a lot of money.</p></blockquote><p>“When is she moving? When did you heard about this?” We’ve all heard this line of dialog on TV. Turns out it’s important to business system development. Here’s why.</p><p>In our <a href="https://tidyfirst.substack.com/p/what-if-you-are-going-to-need-it">previous</a> <a href="https://tidyfirst.substack.com/p/never-forget">posts</a>, we developed the themes of this series:</p><ul><li><p>We can create value by moving some design decisions earlier, in spite of the loss of net present value.</p></li><li><p>Business architecture is one of these cases.</p></li><li><p>Combining human judgement &amp; automation gives us flexibility, scalability, &amp; efficiency.</p></li><li><p>We have to reconcile 2 timelines—what’s going on in the real world out there &amp; what our simplified system model knows about what’s going on, leading us to:</p></li><li><p>Elephant Principle—remember all business information forever.</p></li><li><p>Store data tagged by the time we stored it in the system. This lets us answer questions like, “What was the coverage last Tuesday?” (“Point queries”)</p></li></ul><h2>Whoopsies Happen</h2><p>So far, so good. The previous model of a Customer let us get and set addresses as of dates.</p><p><code>Customer»setAddress(address, posting)<br>Customer»getAddress(posting)</code></p><p>Now our dual timelines come to bite us. Here’s a scenario:</p><ol><li><p>On Monday we find out that the address is 123 Main.</p></li><li><p>On Wednesday we find out that the address is now 456 Main. (This customer moves a lot but not far.)</p></li><li><p>Whoopsie! On Thursday we find out that on Tuesday the customer moved to 789 Main.</p></li></ol><p>We could just say:</p><p><code>customer.address(“789 Main”, tuesday)</code></p><p>Sort of splice the correction into the history. However, we have all of Wednesday’s processing out there based on the wrong address. How can we ask, “What address for Tuesday did I use on Wednesday?”</p><p>In other words, we want to record both:</p><ul><li><p>When this piece of information entered the system.</p></li><li><p>When this piece of information is changed in the outside world.</p></li></ul><div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/$s_!dQJL!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbb11faeb-b6d5-4e09-84a2-d224005d0e88_2268x1106.png" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!dQJL!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbb11faeb-b6d5-4e09-84a2-d224005d0e88_2268x1106.png 424w, https://substackcdn.com/image/fetch/$s_!dQJL!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbb11faeb-b6d5-4e09-84a2-d224005d0e88_2268x1106.png 848w, https://substackcdn.com/image/fetch/$s_!dQJL!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbb11faeb-b6d5-4e09-84a2-d224005d0e88_2268x1106.png 1272w, https://substackcdn.com/image/fetch/$s_!dQJL!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbb11faeb-b6d5-4e09-84a2-d224005d0e88_2268x1106.png 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/bb11faeb-b6d5-4e09-84a2-d224005d0e88_2268x1106.png" width="502" height="244.79395604395606" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/bb11faeb-b6d5-4e09-84a2-d224005d0e88_2268x1106.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:710,&quot;width&quot;:1456,&quot;resizeWidth&quot;:502,&quot;bytes&quot;:3115118,&quot;alt&quot;:&quot;The address changed Tuesday but we didn't find out about it until Thursday&quot;,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="The address changed Tuesday but we didn't find out about it until Thursday" title="The address changed Tuesday but we didn't find out about it until Thursday" srcset="https://substackcdn.com/image/fetch/$s_!dQJL!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbb11faeb-b6d5-4e09-84a2-d224005d0e88_2268x1106.png 424w, https://substackcdn.com/image/fetch/$s_!dQJL!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbb11faeb-b6d5-4e09-84a2-d224005d0e88_2268x1106.png 848w, https://substackcdn.com/image/fetch/$s_!dQJL!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbb11faeb-b6d5-4e09-84a2-d224005d0e88_2268x1106.png 1272w, https://substackcdn.com/image/fetch/$s_!dQJL!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fbb11faeb-b6d5-4e09-84a2-d224005d0e88_2268x1106.png 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><p>Our current model conflates the two.</p><h2>Enter Perspective</h2><p>We need to expand the “tags” for business information. Since this tag is a way to look at the system, we’ll call it “Perspective”</p><div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/$s_!MvCv!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa597cffb-e7ec-4808-bca5-38bf6827f11e_2462x1318.png" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!MvCv!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa597cffb-e7ec-4808-bca5-38bf6827f11e_2462x1318.png 424w, https://substackcdn.com/image/fetch/$s_!MvCv!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa597cffb-e7ec-4808-bca5-38bf6827f11e_2462x1318.png 848w, https://substackcdn.com/image/fetch/$s_!MvCv!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa597cffb-e7ec-4808-bca5-38bf6827f11e_2462x1318.png 1272w, https://substackcdn.com/image/fetch/$s_!MvCv!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa597cffb-e7ec-4808-bca5-38bf6827f11e_2462x1318.png 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/a597cffb-e7ec-4808-bca5-38bf6827f11e_2462x1318.png" width="478" height="255.74313186813185" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/a597cffb-e7ec-4808-bca5-38bf6827f11e_2462x1318.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:779,&quot;width&quot;:1456,&quot;resizeWidth&quot;:478,&quot;bytes&quot;:null,&quot;alt&quot;:&quot;Effective date records when something changed in the world. Posting date records when the system found out.&quot;,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="Effective date records when something changed in the world. Posting date records when the system found out." title="Effective date records when something changed in the world. Posting date records when the system found out." srcset="https://substackcdn.com/image/fetch/$s_!MvCv!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa597cffb-e7ec-4808-bca5-38bf6827f11e_2462x1318.png 424w, https://substackcdn.com/image/fetch/$s_!MvCv!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa597cffb-e7ec-4808-bca5-38bf6827f11e_2462x1318.png 848w, https://substackcdn.com/image/fetch/$s_!MvCv!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa597cffb-e7ec-4808-bca5-38bf6827f11e_2462x1318.png 1272w, https://substackcdn.com/image/fetch/$s_!MvCv!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa597cffb-e7ec-4808-bca5-38bf6827f11e_2462x1318.png 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><p><code>class Perspective:<br>&nbsp; &nbsp; def __init__(self, effective, posting):<br>&nbsp; &nbsp; &nbsp; &nbsp; self.effective = effective<br>&nbsp; &nbsp; &nbsp; &nbsp; self.posting = posting<br>&nbsp; &nbsp; def sees(self, other):<br>&nbsp; &nbsp; &nbsp; &nbsp; return other.posting &lt;= self.posting and other.effective &lt;= self.effective</code></p><p>The key piece of behavior here is that one Perspective only “sees” another if <em>both</em> the posting &amp; effective times (not really just times, but we’ll get to that later) are earlier.</p><p>We use Perspective»sees() when we query a History. To find the event corresponding to a Perspective, we </p><ol><li><p>Filter out all the events that can’t be seen.</p></li><li><p>Sort the visible events by effective date.</p></li><li><p>Return the most recent.</p></li></ol><p><code>class History:<br>&nbsp; &nbsp; def get(self, perspective):<br>&nbsp; &nbsp; &nbsp; &nbsp; visible = filter(lambda x: perspective.sees(x[0]), self._events)<br>&nbsp; &nbsp; &nbsp; &nbsp; freshest = sorted(visible, key=lambda x: x[0].effective, reverse=True)<br>&nbsp; &nbsp; &nbsp; &nbsp; return freshest[0][1]</code></p><p>(Recall that events are stored as a tuple of Perspective (was justing posting) &amp; value. All those [0]’s are starting to bug me so I’ll probably fix that soon.)</p><h2>Example</h2><p>Here is the code I used to drive the above implementation.</p><p><code>monday = 1<br>tuesday = 2<br>wednesday = 3<br>thursday = 4<br><br>customer = Customer()<br>mondayAsOfMonday = Perspective(effective=monday, posting=monday)<br>customer.set_address("123", mondayAsOfMonday)<br>tuesdayAsOfThursday = Perspective(thursday, tuesday)<br>customer.set_address("456", tuesdayAsOfThursday)<br><br>assert customer.get_address(mondayAsOfMonday) == "123"<br>assert customer.get_address(tuesdayAsOfThursday) == "456"<br><br>tuesdayAsOfWednesday = Perspective(wednesday, tuesday)<br>assert customer.get_address(tuesdayAsOfWednesday) == "123"</code></p><h2>So What?</h2><p>You might reasonably ask, “So what? These situations are rare.” Yes, but… First, these situations aren’t all that rare. Run a contract for 20 years &amp; things are bound to get wobbly. Second, the cost of not tracking effective &amp; posting separately compounds. Do you just keep running the contract even though it is wrong? Do you hire a room full of expensive actuaries to manually calculate everything? (I’ve seen both strategies used.) </p><p>The expected cost of effective/posting mismatches is high. Tracking them both, figuring out the right effective/posting combination, can be tough. It’s what we need to do to keep processing inexpensive &amp; scalable.</p><p></p>