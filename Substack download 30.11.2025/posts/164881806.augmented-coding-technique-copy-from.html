<p>One of my experimental projects is to see if I can write a library-quality, performance-competitive basic data structure with a genie. This started when I was building an experimental database project for an experimental programming language (are you sensing a theme here?) project. If you can’t get the data structures right, none of the rest of those higher layers are going to work either.</p><p>This isn’t vibe coding. I care very much about the internal details of these projects because the moment I miss something, the genie does something that hamstrings us later. Well, the genie or I, but I’ll get to that later.</p><div><hr></div><p><em>Thanks so much to sponsor <a href="https://fnf.dev/3HGy5n8">Augment Code</a> (their products appear in this post). Congratulations on the <a href="https://fnf.dev/45JvjHQ">GA release of Remote Agents</a>. I was skeptical when I heard of a horde of free genies running around my code, but I’m warming to the idea. There’s subtlety, nuance, &amp; skill to picking tasks for a remote agent but that’s the joy of working on rapidly changing technology—learning those skills &amp; sharing them. Which is what this community is so good at.</em></p><div><hr></div><h2>B+ Tree</h2><p>The data structure I’m building is an efficient, scalable map. The goals are:</p><ul><li><p>Fast retrieval—O(log n) where n is the number of keys in the map.</p></li><li><p>Fast insertion—O(log n)</p></li><li><p>Fast deletion—O(log n)</p></li><li><p>Crucially, fast range scanning. We want to be able to iterate from key 1 to key 2 in O(m + log n) where m is the number of keys between key 1 &amp; key 2.</p></li></ul><p>The basic operations are put (sometimes called insert), get, delete, &amp; scan. The data is stored in a tree of nodes.</p><ul><li><p>Leaf nodes map from keys to values.</p></li><li><p>Internal, or branch, nodes, map from keys to nodes, either branch nodes or leaf nodes.</p></li><li><p>Nodes have a fixed capacity.</p></li></ul><p>The empty tree is a header object &amp; an empty leaf node:</p><div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/$s_!3x2p!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F559020a2-d6a8-450c-aaf5-9107cc10e8bc.heic" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!3x2p!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F559020a2-d6a8-450c-aaf5-9107cc10e8bc.heic 424w, https://substackcdn.com/image/fetch/$s_!3x2p!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F559020a2-d6a8-450c-aaf5-9107cc10e8bc.heic 848w, https://substackcdn.com/image/fetch/$s_!3x2p!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F559020a2-d6a8-450c-aaf5-9107cc10e8bc.heic 1272w, https://substackcdn.com/image/fetch/$s_!3x2p!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F559020a2-d6a8-450c-aaf5-9107cc10e8bc.heic 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/559020a2-d6a8-450c-aaf5-9107cc10e8bc.heic" width="1456" height="737" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/559020a2-d6a8-450c-aaf5-9107cc10e8bc.heic&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:737,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:160115,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/heic&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:&quot;https://tidyfirst.substack.com/i/164881806?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F559020a2-d6a8-450c-aaf5-9107cc10e8bc.heic&quot;,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/$s_!3x2p!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F559020a2-d6a8-450c-aaf5-9107cc10e8bc.heic 424w, https://substackcdn.com/image/fetch/$s_!3x2p!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F559020a2-d6a8-450c-aaf5-9107cc10e8bc.heic 848w, https://substackcdn.com/image/fetch/$s_!3x2p!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F559020a2-d6a8-450c-aaf5-9107cc10e8bc.heic 1272w, https://substackcdn.com/image/fetch/$s_!3x2p!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F559020a2-d6a8-450c-aaf5-9107cc10e8bc.heic 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><p>After we insert data at keys 1, 2, 3, &amp; 4, the leaf is full:</p><div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/$s_!FSTJ!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a585b2e-0dae-4975-9a69-981019972c11.heic" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!FSTJ!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a585b2e-0dae-4975-9a69-981019972c11.heic 424w, https://substackcdn.com/image/fetch/$s_!FSTJ!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a585b2e-0dae-4975-9a69-981019972c11.heic 848w, https://substackcdn.com/image/fetch/$s_!FSTJ!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a585b2e-0dae-4975-9a69-981019972c11.heic 1272w, https://substackcdn.com/image/fetch/$s_!FSTJ!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a585b2e-0dae-4975-9a69-981019972c11.heic 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/0a585b2e-0dae-4975-9a69-981019972c11.heic" width="1456" height="773" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/0a585b2e-0dae-4975-9a69-981019972c11.heic&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:773,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:236393,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/heic&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:&quot;https://tidyfirst.substack.com/i/164881806?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a585b2e-0dae-4975-9a69-981019972c11.heic&quot;,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/$s_!FSTJ!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a585b2e-0dae-4975-9a69-981019972c11.heic 424w, https://substackcdn.com/image/fetch/$s_!FSTJ!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a585b2e-0dae-4975-9a69-981019972c11.heic 848w, https://substackcdn.com/image/fetch/$s_!FSTJ!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a585b2e-0dae-4975-9a69-981019972c11.heic 1272w, https://substackcdn.com/image/fetch/$s_!FSTJ!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a585b2e-0dae-4975-9a69-981019972c11.heic 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><p>Here’s where the B+ Tree gets tricky. What happens when we insert key 5? </p><div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/$s_!GDGT!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F777b1dc4-bb0e-47d2-a2f3-f7089d95196c.heic" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!GDGT!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F777b1dc4-bb0e-47d2-a2f3-f7089d95196c.heic 424w, https://substackcdn.com/image/fetch/$s_!GDGT!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F777b1dc4-bb0e-47d2-a2f3-f7089d95196c.heic 848w, https://substackcdn.com/image/fetch/$s_!GDGT!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F777b1dc4-bb0e-47d2-a2f3-f7089d95196c.heic 1272w, https://substackcdn.com/image/fetch/$s_!GDGT!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F777b1dc4-bb0e-47d2-a2f3-f7089d95196c.heic 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/777b1dc4-bb0e-47d2-a2f3-f7089d95196c.heic" width="1456" height="926" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/777b1dc4-bb0e-47d2-a2f3-f7089d95196c.heic&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:926,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:226773,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/heic&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:&quot;https://tidyfirst.substack.com/i/164881806?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F777b1dc4-bb0e-47d2-a2f3-f7089d95196c.heic&quot;,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/$s_!GDGT!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F777b1dc4-bb0e-47d2-a2f3-f7089d95196c.heic 424w, https://substackcdn.com/image/fetch/$s_!GDGT!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F777b1dc4-bb0e-47d2-a2f3-f7089d95196c.heic 848w, https://substackcdn.com/image/fetch/$s_!GDGT!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F777b1dc4-bb0e-47d2-a2f3-f7089d95196c.heic 1272w, https://substackcdn.com/image/fetch/$s_!GDGT!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F777b1dc4-bb0e-47d2-a2f3-f7089d95196c.heic 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><p>We need to split the leaf into two leaves &amp; introduce a branch node with the leaves as children:</p><div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/$s_!D0dQ!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fac19fa63-7eb9-4f34-a0ea-c13aa129ccdd.heic" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!D0dQ!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fac19fa63-7eb9-4f34-a0ea-c13aa129ccdd.heic 424w, https://substackcdn.com/image/fetch/$s_!D0dQ!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fac19fa63-7eb9-4f34-a0ea-c13aa129ccdd.heic 848w, https://substackcdn.com/image/fetch/$s_!D0dQ!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fac19fa63-7eb9-4f34-a0ea-c13aa129ccdd.heic 1272w, https://substackcdn.com/image/fetch/$s_!D0dQ!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fac19fa63-7eb9-4f34-a0ea-c13aa129ccdd.heic 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/ac19fa63-7eb9-4f34-a0ea-c13aa129ccdd.heic" width="1456" height="824" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/ac19fa63-7eb9-4f34-a0ea-c13aa129ccdd.heic&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:824,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:253386,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/heic&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:&quot;https://tidyfirst.substack.com/i/164881806?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fac19fa63-7eb9-4f34-a0ea-c13aa129ccdd.heic&quot;,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/$s_!D0dQ!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fac19fa63-7eb9-4f34-a0ea-c13aa129ccdd.heic 424w, https://substackcdn.com/image/fetch/$s_!D0dQ!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fac19fa63-7eb9-4f34-a0ea-c13aa129ccdd.heic 848w, https://substackcdn.com/image/fetch/$s_!D0dQ!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fac19fa63-7eb9-4f34-a0ea-c13aa129ccdd.heic 1272w, https://substackcdn.com/image/fetch/$s_!D0dQ!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fac19fa63-7eb9-4f34-a0ea-c13aa129ccdd.heic 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><p>There are several tricky edge cases to get right in insertion &amp; splitting, especially when we have a multi-level tree &amp; leaf splitting triggers branch splitting. And insertion isn’t even the tricky bit. Deletion is a nightmare.</p><p>Supporting the fast scan operation requires that the leaf nodes are all at the same (bottom) level of the tree &amp; that they are linked together. </p><div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/$s_!mm6a!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00775aa5-0bdf-4d44-ba3b-37b4d7038e4c.heic" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!mm6a!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00775aa5-0bdf-4d44-ba3b-37b4d7038e4c.heic 424w, https://substackcdn.com/image/fetch/$s_!mm6a!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00775aa5-0bdf-4d44-ba3b-37b4d7038e4c.heic 848w, https://substackcdn.com/image/fetch/$s_!mm6a!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00775aa5-0bdf-4d44-ba3b-37b4d7038e4c.heic 1272w, https://substackcdn.com/image/fetch/$s_!mm6a!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00775aa5-0bdf-4d44-ba3b-37b4d7038e4c.heic 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/00775aa5-0bdf-4d44-ba3b-37b4d7038e4c.heic" width="1456" height="789" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/00775aa5-0bdf-4d44-ba3b-37b4d7038e4c.heic&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:789,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:174230,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/heic&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:&quot;https://tidyfirst.substack.com/i/164881806?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00775aa5-0bdf-4d44-ba3b-37b4d7038e4c.heic&quot;,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/$s_!mm6a!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00775aa5-0bdf-4d44-ba3b-37b4d7038e4c.heic 424w, https://substackcdn.com/image/fetch/$s_!mm6a!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00775aa5-0bdf-4d44-ba3b-37b4d7038e4c.heic 848w, https://substackcdn.com/image/fetch/$s_!mm6a!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00775aa5-0bdf-4d44-ba3b-37b4d7038e4c.heic 1272w, https://substackcdn.com/image/fetch/$s_!mm6a!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00775aa5-0bdf-4d44-ba3b-37b4d7038e4c.heic 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><h2>Experiment</h2><p>This is an experiment in augmented coding not a data structures tutorial so I’ll save the B+ Tree details for another day (it’s <em>so cool</em> though y’all!) I’ve been working on <a href="https://github.com/KentBeck/BPlusTree3">this project</a> off and on for the better part of a month, including <a href="https://github.com/KentBeck/BPlusTree">starting over</a> <a href="https://github.com/KentBeck/BPlusTree2">twice</a> when things got too complicated for the genie to make further progress. For educational purposes I’m implementing it in Rust, a language I hadn’t touched until I started the project.</p><p>The problem I kept running into was runaway complexity. The genie would implement the next feature, but add excess complexity in the process. The next feature took longer &amp; had more stumbles along the way. Eventually the genie just couldn’t make further progress.</p><div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/$s_!efqO!,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973e2cde-c10b-444f-8a81-dd75581865eb.heic" data-component-name="Image2ToDOM"><div class="image2-inset"><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/$s_!efqO!,w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973e2cde-c10b-444f-8a81-dd75581865eb.heic 424w, https://substackcdn.com/image/fetch/$s_!efqO!,w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973e2cde-c10b-444f-8a81-dd75581865eb.heic 848w, https://substackcdn.com/image/fetch/$s_!efqO!,w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973e2cde-c10b-444f-8a81-dd75581865eb.heic 1272w, https://substackcdn.com/image/fetch/$s_!efqO!,w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973e2cde-c10b-444f-8a81-dd75581865eb.heic 1456w" sizes="100vw"><img src="https://substack-post-media.s3.amazonaws.com/public/images/973e2cde-c10b-444f-8a81-dd75581865eb.heic" width="1456" height="871" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/973e2cde-c10b-444f-8a81-dd75581865eb.heic&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:871,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:228039,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/heic&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:&quot;https://tidyfirst.substack.com/i/164881806?img=https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973e2cde-c10b-444f-8a81-dd75581865eb.heic&quot;,&quot;isProcessing&quot;:false,&quot;align&quot;:null,&quot;offset&quot;:false}" class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/$s_!efqO!,w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973e2cde-c10b-444f-8a81-dd75581865eb.heic 424w, https://substackcdn.com/image/fetch/$s_!efqO!,w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973e2cde-c10b-444f-8a81-dd75581865eb.heic 848w, https://substackcdn.com/image/fetch/$s_!efqO!,w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973e2cde-c10b-444f-8a81-dd75581865eb.heic 1272w, https://substackcdn.com/image/fetch/$s_!efqO!,w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973e2cde-c10b-444f-8a81-dd75581865eb.heic 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></button><button tabindex="0" type="button" class="pencraft pc-reset pencraft icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2 lucide-maximize-2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></button></div></div></div></a></figure></div><p>The particular problem in my project was that two sources of complexity compound:</p><ul><li><p>Rust’s ownership system meant that many otherwise-sensible choices weren’t available, &amp; keeping the ownership system happy in the face of changes was increasingly difficult.</p></li><li><p>The algorithmic complexity of the the problem, especially the deletion code.</p></li></ul><p>Eventually the genie would code itself out of options &amp; I started over. I don’t (or at least didn’t) know enough about Rust to keep it out of trouble or get it out of trouble.</p><h2> Again?</h2><p>I started the third iteration with diminished expectations. I gave the genie explicit guidance to work one test case at a time, to continually refactor, to separate commits into behavior or structure changes, the whole packaged. Things went better at first but then I could feel the tar start to grab my boots.</p><p>“Not again!” That’s when I really noticed the compounding effect of the 2 sources of complexity. Maybe the problem is over-constrained? Can I tackle the complexity separately?</p><p>So I asked the genie to write a Python implementation of the B+ Tree, using the same system prompt I had been using. I guided it into roughly the design I expected. In a day I had comprehensive test cases passing with tidy code. (Along with a fuzz tester to discover new corner cases. Pro tip—your genie is <em>great</em> at coming up with special purpose testing tools!)</p><p>That’s when I thought, “This is a perfect task for an autonomous agent!” I had early access to Augment’s Remote Agent (disclosure—they sponsor the newsletter). So, as an experiment, I prompted, “Throw away the current Rust code. Start over &amp; copy the Python code. Translate a test &amp; make it work. Keep going until you have translated all the tests.”</p><h2>Results!</h2><p>I intervened a few times in the next hour or so, but what came out was idiomatic Rust that actually passed all the tests. The complexity was much lower than what I had before. And, while it was running, I used Codex to write a C extension for the Python code to get the performance of the Python to within spitting distance of the standard Python SortedDict. Because the autonomous agent was working in a different environment, I could have both genies going at the same time without having to worry about conflicts.</p><p>I think the keys to the successful outcome of the experiment were:</p><ul><li><p>Limited complexity. I haven’t tried the experiment (but now I will) of throwing the autonomous genie at the problem of writing a B+ Tree from scratch &amp; see what it comes up with. Seems like not dealing with all that complexity at once is a key.</p></li><li><p>Clear outcome. I wasn’t having the genie come up with the tests &amp; the code. Here are the tests. Make them work.</p></li><li><p>Clear scope. Again, the tests limit the scope. Make them work. With tidy code. Don’t make up any new requirements. Don’t volunteer any scope. This. Only this. (Can you tell I’ve gotten burned by genies over-doing scope?)</p></li></ul><p>I’ve since tried autonomous agents on other tasks that seem to meet the above criteria. For example, I wanted to use the Option combinator to simplify code everywhere in the code base. It worked pretty well.</p><p>The free genie holds great promise, but it needs to be on tasks that don’t tickle the genie’s weak spots.</p><p></p>